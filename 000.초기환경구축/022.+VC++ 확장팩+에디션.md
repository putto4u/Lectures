## VirtualBox 및 DevOps 도구 통합 배포 최종 프로젝트

Windows 호스트 PC 환경에서 **Visual C++ 런타임**, **VirtualBox**, **확장팩**, **VM 생성**, **게스트 에디션 ISO 마운트** 및 **내부 DevOps 도구**까지 구축하는 전체 프로젝트 구성입니다. 요청하신 대로 실행 명령까지 포함하여 완결된 형태로 작성했습니다.

---

### 1. 프로젝트 디렉토리 구조

```text
ansible-devops-project/
├── inventory/
│   └── hosts.ini            # 대상 Windows 호스트 PC 리스트
├── vars/
│   └── main.yml             # 설치 경로, 버전 및 ISO 정보
└── site.yml                 # 전체 공정을 제어하는 메인 플레이북

```

---

### 2. 파일별 상세 내용

#### ① 인벤토리 설정 (`inventory/hosts.ini`)

대상 PC의 IP와 접속 정보를 설정합니다.

```ini
[physical_pcs]
pc-01 ansible_host=192.168.1.10
pc-02 ansible_host=192.168.1.11

[physical_pcs:vars]
ansible_user=Administrator
ansible_password=YourPassword
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore

```

#### ② 변수 정의 (`vars/main.yml`)

설치에 필요한 URL 및 VM 사양을 정의합니다.

```yaml
# 선행 필수 및 VirtualBox 관련 URL
vcredist_url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
vbox_installer_url: "https://download.virtualbox.org/virtualbox/7.0.12/VirtualBox-7.0.12-159484-Win.exe"
ext_pack_url: "https://download.virtualbox.org/virtualbox/7.0.12/Oracle_VM_VirtualBox_Extension_Pack-7.0.12.vbox-extpack"
# 확장팩 라이선스 승인을 위한 해시값 (버전별로 상이할 수 있음)
ext_pack_hash: "33d7284dc4a0ece278f985c002b881fd92b35887955e59824e5c0162dbf03d60"

# VM 설정
vm_name: "DevOps-Master-VM"
vm_memory: 4096
vm_cpus: 2
# VirtualBox 설치 시 기본 포함되는 게스트 에디션 ISO 경로
guest_additions_iso: "C:\\Program Files\\Oracle\\VirtualBox\\VBoxGuestAdditions.iso"

```

#### ③ 메인 플레이북 (`site.yml`)

```yaml
---
- name: Windows 호스트 가상화 및 DevOps 환경 통합 구축
  hosts: physical_pcs
  vars_files:
    - vars/main.yml

  tasks:
    # [STEP 1] VC++ 런타임 설치 (VBox 설치 선행 조건)
    - name: Microsoft Visual C++ Redistributable 설치
      win_package:
        path: "{{ vcredist_url }}"
        arguments: /install /quiet /norestart
        state: present

    # [STEP 2] VirtualBox 본체 설치
    - name: VirtualBox 소프트웨어 설치
      win_package:
        path: "{{ vbox_installer_url }}"
        arguments: /s
        state: present

    # [STEP 3] 확장팩(Extension Pack) 설치
    - name: 확장팩 다운로드
      win_get_url:
        url: "{{ ext_pack_url }}"
        dest: 'C:\Temp\VBoxExtPack.vbox-extpack'

    - name: 확장팩 라이선스 승인 및 설치
      win_shell: |
        $vboxManage = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        & $vboxManage extpack install --replace --accept-license={{ ext_pack_hash }} 'C:\Temp\VBoxExtPack.vbox-extpack'
      ignore_errors: yes

    # [STEP 4] VM 생성 및 게스트 에디션 ISO 마운트
    - name: VM 생성 및 하드웨어 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        # 1. VM 등록
        & $vbox createvm --name "{{ vm_name }}" --register
        # 2. 메모리, CPU, 네트워크(브릿지) 설정
        & $vbox modifyvm "{{ vm_name }}" --memory {{ vm_memory }} --cpus {{ vm_cpus }} --nic1 bridged
        # 3. 스토리지 컨트롤러 추가 및 게스트 에디션 ISO 마운트
        & $vbox storagectl "{{ vm_name }}" --name "IDE Controller" --add ide
        & $vbox storageattach "{{ vm_name }}" --storagectl "IDE Controller" --port 0 --device 0 --type dvddrive --medium "{{ guest_additions_iso }}"

    # [STEP 5] VM 기동 및 내부 도구 배포 준비
    - name: VM 최종 기동
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        & $vbox startvm "{{ vm_name }}" --type headless

    - name: 배포 완료 상태 출력
      debug:
        msg: "{{ vm_name }} 생성이 완료되었습니다. 이제 VM 내부에서 DevOps 도구 설치를 진행하십시오."

```

---

### 3. 최종 실행 명령어

프로젝트 루트 디렉토리(`ansible-devops-project/`)에서 아래 명령어를 실행하여 전체 공정을 시작합니다.

```bash
# 앤서블 플레이북 실행 명령
ansible-playbook -i inventory/hosts.ini site.yml

```

---

### 4. 결과 확인 및 검증 방법

| 확인 항목 | 확인 방법 (명령어/위치) |
| --- | --- |
| **VC++ 설치** | 제어판 > 프로그램 및 기능 > Microsoft Visual C++ 2015-2022 확인 |
| **VBox 설치** | `VBoxManage --version` 실행 후 버전 출력 확인 |
| **확장팩 활성** | `VBoxManage list extpacks` 실행 시 'Active' 상태 확인 |
| **VM 구동 상태** | `VBoxManage list runningvms` 실행 시 "{{ vm_name }}" 목록 확인 |
| **ISO 마운트** | VM 설정 > 저장소 섹션에 `VBoxGuestAdditions.iso` 삽입 확인 |

---

### ⚠️ 비용 및 환경 주의사항

* **AWS 기반 Windows 호스트**: 중첩 가상화가 가능한 Bare Metal(`metal`) 인스턴스 사용 시 **시간당 약 $4~$7 이상의 비용**이 발생하므로 테스트 직후 인스턴스를 반드시 종료(Terminate)하십시오.
* **유료 전환 가능성**: VirtualBox 확장팩은 상업적 이용 시 라이선스 비용이 발생할 수 있습니다. 기업 내 수십 대 배포 시 반드시 정책을 확인하십시오.

**Next Step:** VM 내부(Ubuntu) 자동화를 위한 `ansible_host` 동적 추가 방법

위의 호스트 설정이 완료된 후, 생성된 VM 내부의 IP를 자동으로 찾아내어 다음 앤서블 작업으로 넘겨주는 '동적 인벤토리' 구성이 필요하시면 말씀해 주세요. 전체 흐름에 포함해 드리겠습니다.
