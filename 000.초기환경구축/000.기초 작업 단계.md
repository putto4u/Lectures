# 1. 초기 환경 구축 Lab Step


1. 전 PC IP/Mac 수집하기
   
2. 버춸박스6.0.12 다운로드, 확장팩 다운로드 -> 설치
   
**이전 VM 청소하기**
설정 폴더 삭제
C:\Users\[사용자명]\.VirtualBox (점으로 시작하는 폴더)
C:\Users\[사용자명]\AppData\Local\Oracle
설치 잔여 파일 확인
C:\Program Files\Oracle\VirtualBox (해당 경로에 폴더가 남아 있다면 삭제)


**버춸박스 새로 설치하기**  
VM 폴더 : D:\VirtuslBox  만들어서 선택  
설정사항 : 일반 : Features-양방향, 양방향  
          시스템 : cpu :1     
                   memory: 2G    
                   **UEFI 체크** 
                   **마더보드 - Pointing Device - ps/2 마우스 선택**
          디스크 : vm1,2...용량 25G (마스터는 50G)    
          네트워크 : 어댑터 브리지, Promiscuous Mode : 모두 허용  
          디스플레이 : 3D 가속 체크
          공유폴더 : 추가버튼  D:/vm_share   
                              Mount Point : /vm_share,  읽기 전용 빼고 다 체크  

설치후 스토리지 파티션 설정 : $ sudo swapoff -a     
     부팅시 자동 마운 해제 : $ sudo vi /etc/fstab    
                              # /swap.img none  swap sw 0  0   # 맨 앞에 주석처리 #추가  

3. 우분두 LTS 24.04.23 다운로드 3.1GB - 

```
버춸-장치-CD - Guest Addition iso 선택  # 클립보드 공유 등
sudo mkdir -p /media/cdrom
sudo mount /dev/cdrom /media/cdrom
sudo /media/cdrom/VBoxLinuxAdditions.run

cd ~
sudo umount /mnt/cdrom
sudo rm -rf /mnt/cdrom
sudo reboot

sudo apt update
sudo apt install -y build-essential dkms linux-headers-$(uname -r)  

sudo apt install openssh-server tree net-tools ufw nmap git curl wget -y
sudo apt install neofetch  htop
sudo apt install numlockx sshpass -y 
sudo apt install  software-properties-common -y  
sudo add-apt-repository --yes --update ppa:ansible/ansible  
sudo apt install ansible -y
# sudo usermod -aG vboxsf $USER   # 사용자 장치제어 그룹 포함
sudo apt install python3 -y
sudo apt install -y bash-completion
sudo curl https://raw.githubusercontent.com/docker/docker-ce/master/components/cli/contrib/completion/bash/docker -o /etc/bash_completion.d/docker
sudo apt install -y ca-certificates curl gnupg lsb-release
# sudo apt install containerd.io -y
# sudo apt install -y docker-compose-plugin
sudo apt upgrade -y



```

**sudo vi /etc/hosts**
  ```
  127.0.0.1   vmmaster01 

  192.168.1번호.251
**sudo vi /etc/hostname**  

4. wsl 설치  : 윈도우환경에서 리눅스 명령을 실습할수 있는 프로그램
   윈도우-> 검색 -> **파워쉘에서 실행** 
   ```bash
   > wsl --install
   ```
5. xshell 설치
6. AWS cli 설치
5. 버춸박스에서 VM 만들기 - 1. 우분투VM  3개~5개 만들기====> 2번 설정 참조
                        



-----------------
## 네트워크 및 인프라 통합 자동화 프로젝트

본 프로젝트는 앤서블(Ansible)을 사용하여 로컬 작업 환경 초기화부터 네트워크 장비 설정, 그리고 22대 노드(마스터 2대, 워커 20대)의 가상화 환경 구축까지 전 과정을 자동화합니다.

---

### 1. 프로젝트 초기화 및 인벤토리 생성 (`init_project.yml`)

로컬 디렉토리를 정리하고, 22대의 장비 정보가 담긴 인벤토리 파일을 생성합니다.

```yaml
---
- name: 1. 프로젝트 디렉토리 및 인벤토리 초기화
  hosts: localhost
  connection: local
  tasks:
    - name: 기존 디렉토리 삭제 후 재생성
      file:
        path: "./ansible_config"
        state: "{{ item }}"
      loop: [absent, directory]

    - name: 인벤토리 파일 생성 (22대 등록)
      copy:
        dest: "./ansible_config/inventory.ini"
        content: |
          # [실행방법]: ansible-playbook -i inventory.ini <파일명>.yml
          
          [router]
          Gateway ansible_host=192.168.1.1 ansible_user=admin ansible_password=12345678

          [masters]
          master1 ansible_host=192.168.1.10 mac_addr=00:11:22:AA:BB:01
          master2 ansible_host=192.168.1.11 mac_addr=00:11:22:AA:BB:02

          [workers]
          {% for i in range(1, 21) %}
          pc{{ "%02d" | format(i) }} ansible_host=192.168.1.{{ 100 + i }} mac_addr=00:11:22:CC:DD:{{ "%02d" | format(i) }}
          {% endfor %}

          [all_nodes:children]
          masters
          workers

```

---

### 2. 공유기 고정 IP 일괄 등록 (`setup_router.yml`)

인벤토리에 정의된 MAC 주소 데이터를 공유기에 전송하여 IP를 예약합니다.

```yaml
---
- name: 2. 공유기 DHCP 고정 IP 등록
  hosts: router
  gather_facts: no
  tasks:
    - name: 22대 노드 IP 예약 명령 실행
      raw: "dhcp-server add --mac={{ hostvars[item].mac_addr }} --ip={{ hostvars[item].ansible_host }} --name={{ item }}"
      loop: "{{ groups['all_nodes'] }}"

```

---

### 3. 마스터 및 워커 노드 인프라 구축 (`setup_infrastructure.yml`)

모든 PC에 계정을 생성하고, VirtualBox 및 우분투 VM을 구축합니다.

```yaml
---
- name: 3. 마스터 및 워커 노드 통합 세팅
  hosts: all_nodes
  become: yes
  vars:
    user_pw: "{{ '12345678' | password_hash('sha512') }}"
  
  tasks:
    - name: master 계정 생성 및 sudo 권한 부여
      user:
        name: master
        password: "{{ user_pw }}"
        shell: /bin/bash
        groups: sudo

    - name: root 계정 비밀번호 설정
      user:
        name: root
        password: "{{ user_pw }}"

    - name: 앤서블 및 VirtualBox LTS 설치
      apt:
        name: [ansible, virtualbox, virtualbox-ext-pack]
        state: present
        update_cache: yes

    - name: 우분투 서버 LTS VM 생성 (브리지 모드)
      become_user: master
      shell: |
        vboxmanage createvm --name "Srv-LTS" --register
        vboxmanage modifyvm "Srv-LTS" --memory 2048 --nic1 bridged --bridgeadapter1 eth0
      ignore_errors: yes

    # VM 내부 계정 설정은 일반적으로 Cloud-init이나 별도 ISO 이미지를 통해 수행되나,
    # 여기서는 VM 생성 로직까지만 구현합니다.

```

---

### 4. 실행 방법 안내

모든 파일 준비가 완료되면 터미널에서 순서대로 아래 명령어를 입력하여 전체 인프라를 구축합니다.

```bash
# 1단계: 프로젝트 초기화 (디렉토리 및 인벤토리 생성)
ansible-playbook init_project.yml

# 생성된 디렉토리로 이동
cd ansible_config

# 2단계: 공유기 세팅
ansible-playbook -i inventory.ini ../setup_router.yml

# 3단계: 마스터 및 워커 노드 전체 인프라 배포
ansible-playbook -i inventory.ini ../setup_infrastructure.yml --ask-become-pass

```

---

### 5. 핵심 체크리스트 및 과금 안내

* **VirtualBox 브리지 어댑터**: 플레이북의 `bridgeadapter1 eth0` 부분은 실제 물리 PC의 네트워크 인터페이스 이름(예: `enp3s0`, `eth0`, `wlan0`)으로 수정해야 정상 작동합니다.
* **AWS 환경 확장**: 위 구성을 AWS EC2에서 실행할 경우, 중첩 가상화(Nested Virtualization)를 지원하는 인스턴스 타입(예: **인텔 제온 기반 하이 메모리 타입**)을 사용해야 하며, 이는 프리티어에 포함되지 않아 **시간당 약 $0.05 이상의 비용**이 발생할 수 있습니다.
* **보안**: 비밀번호 `12345678`이 평문으로 노출되어 있으므로, 실제 운영 시에는 `ansible-vault`를 사용하여 암호화하는 것을 강력히 권장합니다.

---

Next Step: VirtualBox VM 내부 자동 응답 설치(Unattended Install) 설정

Next Step: 마스터 노드 간 SSH 키 기반 무암호 접속 자동화 구성
