인텔 칩 맥북(macOS Big Sur) 환경에 맞춰 프로젝트를 최적화했습니다. 인텔 맥북은 가상화 기술(VT-x)이 안정적이라 VirtualBox 구동에 유리하지만, 최신 `v7.x` 버전보다는 **`v6.1.x`** 계열이 Big Sur에서 더 안정적일 수 있습니다.

또한 요청하신 대로 디스크 용량은 **20GB**로 고정하여 구성했습니다.

---

### 1. 프로젝트 디렉토리 구조

```text
ansible-devops-mac-intel/
├── inventory/
│   └── hosts.ini            # 맥북 SSH 접속 정보 및 VM 설정
├── vars/
│   ├── main.yml             # macOS Intel 경로 및 20GB 디스크 설정
│   └── packages.yml         # 설치할 공통 패키지 목록
└── site.yml                 # macOS 전용 통합 플레이북

```

---

### 2. 파일별 상세 내용

#### ① 인벤토리 설정 (`inventory/hosts.ini`)

맥북은 SSH를 통해 제어하므로 `ansible_connection=ssh`를 사용합니다.

```ini
[mac_hosts]
# 맥북IP | VM고정IP | 게이트웨이 | DNS
my-mac-intel ansible_host=192.168.0.5 vm_static_ip=192.168.0.101 vm_gw=192.168.0.1 vm_dns=8.8.8.8

[mac_hosts:vars]
ansible_user="내_맥북_계정명"
ansible_ssh_pass="내_맥북_비밀번호"
ansible_connection=ssh

```

#### ② 메인 변수 정의 (`vars/main.yml`)

인텔 맥북의 경로와 **20GB** 디스크 설정을 반영했습니다.

```yaml
# 우분투 22.04 LTS ISO 다운로드 URL 및 저장 경로
ubuntu_iso_url: "https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso"
iso_storage_path: "{{ ansible_env.HOME }}/Downloads/ubuntu-22.04-server.iso"

# macOS VirtualBox 실행 경로 (기본 설치 경로)
vbox_path: "/usr/local/bin/VBoxManage"

vm_name: "DevOps-Intel-VM"
vm_user: "master"
vm_pass: "1234"
vm_memory: 2048
vm_cpus: 2

# 디스크 설정 (20GB 반영)
vm_disk_size: 20480
vm_disk_path: "{{ ansible_env.HOME }}/VirtualBox VMs/{{ vm_name }}/{{ vm_name }}.vdi"
# Big Sur 환경의 ISO 경로
guest_iso: "/Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso"

```

#### ③ 통합 플레이북 (`site.yml`)

인텔 칩 맥북의 터미널 환경에서 실행될 명령들을 구성했습니다.

```yaml
---
# [STEP 0] 우분투 ISO 파일 다운로드 (파일이 없을 때만 실행)
    - name: 우분투 ISO 파일 다운로드
      get_url:
        url: "{{ ubuntu_iso_url }}"
        dest: "{{ iso_storage_path }}"
        mode: '0644'
      register: iso_download
      until: iso_download is succeeded
      retries: 3
      delay: 10

- name: macOS Big Sur(Intel) 호스트 가상화 및 VM 자동화
  hosts: mac_hosts
  vars_files:
    - vars/main.yml
    - vars/packages.yml

  tasks:
    # [STEP 1] VirtualBox 설치 여부 확인
    - name: VirtualBox 설치 확인
      shell: which VBoxManage
      register: vbox_check
      ignore_errors: yes

    - name: 중단 안내
      fail:
        msg: "맥북에 VirtualBox가 없습니다. Intel용 VirtualBox를 먼저 설치하세요."
      when: vbox_check.rc != 0

    # [STEP 2] VM 생성 및 20GB 가상 디스크 구성
    - name: VM 및 가상 디스크 생성
      shell: |
        if ! ("{{ vbox_path }}" list vms | grep "{{ vm_name }}"); then
          # VM 생성 및 등록
          "{{ vbox_path }}" createvm --name "{{ vm_name }}" --register
          
          # 저장소 폴더 생성 및 20GB 디스크 할당
          mkdir -p "$(dirname "{{ vm_disk_path }}")"
          "{{ vbox_path }}" createmedium disk --filename "{{ vm_disk_path }}" --size {{ vm_disk_size }} --format VDI
          
          # 하드웨어 설정
          "{{ vbox_path }}" modifyvm "{{ vm_name }}" --memory {{ vm_memory }} --cpus {{ vm_cpus }} --nic1 bridged --bridgeadapter1 "en0"
          
          # 컨트롤러 추가 및 디스크/ISO 연결
          "{{ vbox_path }}" storagectl "{{ vm_name }}" --name "SATA" --add sata
          "{{ vbox_path }}" storageattach "{{ vm_name }}" --storagectl "SATA" --port 0 --device 0 --type hdd --medium "{{ vm_disk_path }}"
          "{{ vbox_path }}" storageattach "{{ vm_name }}" --storagectl "SATA" --port 1 --device 0 --type dvddrive --medium "{{ guest_iso }}"
        fi

    # [STEP 3] VM 내부 마스터 계정 설정
    - name: master 계정 보안 설정
      shell: |
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }}:{{ vm_pass }}' | chpasswd"
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"

    # [STEP 4] SSH 키 주입
    - name: 맥북의 SSH 공개키 복사
      shell: |
        pubKey=$(cat ~/.ssh/id_rsa.pub)
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /bin/bash -c "mkdir -p ~/.ssh && echo '$pubKey' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

    # [STEP 5] 고정 IP 설정 (Ubuntu Netplan)
    - name: 네트워크 고정 IP 설정
      shell: |
        cat <<EOF > /tmp/01-netcfg.yaml
        network:
          version: 2
          renderer: networkd
          ethernets:
            enp0s3:
              dhcp4: no
              addresses: [{{ vm_static_ip }}/24]
              gateway4: {{ vm_gw }}
              nameservers:
                addresses: [{{ vm_dns }}]
        EOF
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" copyto --username {{ vm_user }} --password {{ vm_pass }} "/tmp/01-netcfg.yaml" "/tmp/01-netcfg.yaml"
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- sudo mv /tmp/01-netcfg.yaml /etc/netplan/01-netcfg.yaml
        "{{ vbox_path }}" guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- sudo netplan apply

```

---

### 3. 맥북 선행 작업 (Big Sur 전용)

1. **원격 로그인 허용**: `시스템 환경설정 > 공유 > 원격 로그인`을 체크하고 '모든 사용자' 또는 본인 계정을 추가하세요.
2. **커널 확장 허용**: Big Sur 설치 시 VirtualBox 커널 확장이 차단될 수 있습니다. 설치 후 `보안 및 개인 정보 보호`에서 Oracle의 소프트웨어를 **허용**해야 합니다.
3. **SSH 키 확인**: 터미널에서 `ls ~/.ssh/id_rsa.pub`가 있는지 확인하고, 없다면 `ssh-keygen`으로 생성하세요.

---

개인 맞춤 설정 검토 완료: macOS Big Sur/Intel 환경 반영, SSH 기반 접속 설정, 디스크 20GB 적용, 깃허브 포맷 준수.

Next Step: 인텔 맥북에서 가상화 기술(VT-x) 활성화 여부 확인 방법 정립
