## VirtualBox 및 DevOps 도구 통합 배포 최종 프로젝트 (개정판)

이 프로젝트는 Windows 호스트 환경에서 VirtualBox 인프라를 구축하고, 생성된 VM 내부의 보안 및 네트워크 설정을 자동화하는 전체 공정을 포함합니다. 요청하신 사용자 계정 설정, SSH 키 주입, 네트워크 고정 IP 설정 및 가변적인 설치 프로그램 관리 기능을 추가하였습니다.

---
## 대상 PC 선행작업  
WinRM 설정은 **'닭과 달걀'**의 문제입니다. 앤서블이 대상 PC에 접속하려면 WinRM이 열려 있어야 하는데, WinRM을 여는 작업을 앤서블로 할 수는 없기 때문입니다. 따라서 **최초 1회**는 대상 Windows PC에서 수동으로(또는 USB, Active Directory GPO 등을 통해) 설정을 해주어야 합니다.

대상 PC에서 setup_winrm.ps1 파일을 다운로드 받아 관리자권한으로 한번 실행시켜주세요.

---

## 1. 프로젝트 디렉토리 구조

```text
ansible-devops-project/
├── inventory/
│   └── hosts.ini            # 호스트 및 VM 네트워크 정보
├── vars/
│   ├── main.yml             # 시스템 경로 및 인프라 설정
│   └── packages.yml         # [신규] 초기 설치 프로그램 목록
├── scripts/
│   └── setup_winrm.ps1      # [최초 1회용] WinRM 활성화 스크립트
└── site.yml                 # 전체 공정 통합 플레이북

```

---

## 2. 파일별 상세 내용

### ① [최초 실행용] WinRM 활성화 스크립트 (`scripts/setup_winrm.ps1`)

앤서블 접속이 막혔을 때, 대상 Windows PC에서 **관리자 권한**으로 딱 한 번만 실행하면 모든 방화벽과 포트를 열어줍니다.

```powershell
# 1. 최신 스크립트 URL 설정
$url = "https://raw.githubusercontent.com/ansible/ansible-documentation/devel/examples/scripts/ConfigureRemotingForAnsible.ps1"
$file = "$env:temp\ConfigureRemotingForAnsible.ps1"

# 2. TLS 1.2 보안 프로토콜 설정 (다운로드 실패 방지)
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# 3. 스크립트 다운로드
(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)

# 4. 스크립트 실행 (네트워크 프로필 체크 건너뛰기 포함)
powershell.exe -ExecutionPolicy Bypass -File $file -SkipNetworkProfileCheck
```

**대상 pc 관리자권한으로 파워쉘 실행**
```CMD
>Set-ExecutionPolicy RemoteSigned
y 또는 A 응답

$> cd C:\scripts
$> .\setup_winrm.ps1

#### 실패시 한줄 씩 실행하세요.
```

#### WinRM 서비스 확인 및 방화벽 수동 개방 (HTTPS 5986)
```
netsh advfirewall firewall add rule name="WinRM-HTTPS" dir=in action=allow protocol=TCP localport=5986
```




### ② 인벤토리 설정 (`inventory/hosts.ini`)

```ini
[physical_pcs]
# 호스트IP | VM고정IP | 게이트웨이 | DNS
pc-01 ansible_host=192.168.0.3 vm_static_ip=192.168.0.101 vm_gw=192.168.0.1 vm_dns=8.8.8.8
pc-02 ansible_host=192.168.0.4 vm_static_ip=192.168.0.102 vm_gw=192.168.0.1 vm_dns=8.8.8.8

[physical_pcs:vars]
ansible_user=Administrator
ansible_password=YourPassword
ansible_port=5986
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore

```
## 다음을 진행하기 전에 우분투 ISO 파일을 다운받지 않고 마스터서버에서 각 노드로 전송하는 작업을 하는 것이 네트워크 부담을 줄입니다. 

### ③ 설치 프로그램 리스트 (`vars/packages.yml`)

간단하게 리스트만 관리하여 차후 수정이 용이하게 만들었습니다.

```yaml
# VM 내부(Linux)에 설치할 패키지 목록
common_packages:
  - git
  - curl
  - wget
  - vim
  - net-tools
  - openssh-server

```

### ④ 메인 변수 정의 (`vars/main.yml`)

```yaml
# 우분투 ISO 다운로드 정보
ubuntu_iso_url: "https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso"
# 다운로드 받을 로컬 경로 (C 드라이브 루트나 사용자 폴더 권장)
iso_storage_path: "C:\\VM_Storage\\ubuntu-22.04-server.iso"

# 기존 변수 유지
vm_disk_path: "C:\\VM_Storage\\{{ vm_name }}.vdi"

vcredist_url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
vbox_installer_url: "https://download.virtualbox.org/virtualbox/7.0.12/VirtualBox-7.0.12-159484-Win.exe"
ext_pack_url: "https://download.virtualbox.org/virtualbox/7.0.12/Oracle_VM_VirtualBox_Extension_Pack-7.0.12.vbox-extpack"
ext_pack_hash: "33d7284dc4a0ece278f985c002b881fd92b35887955e59824e5c0162dbf03d60"

vm_name: "DevOps-Master-VM"
vm_user: "master"
vm_pass: "1234"  # 강제 입력 비밀번호
guest_iso: "C:\\Program Files\\Oracle\\VirtualBox\\VBoxGuestAdditions.iso"
vm_memory: 2048
vm_cpus: 2
vm_disk_size: 20480  # 단위: MB (20GB)
vm_disk_path: "D:\\VM_Storage\\{{ vm_name }}.vdi" # 디스크 저장 경로
```

### ⑤ 통합 플레이북 (`site.yml`)

```yaml
---
- name: 호스트 환경 구축 및 VM 내부 설정 통합 프로젝트
  hosts: physical_pcs
  vars_files:
    - vars/main.yml
    - vars/packages.yml

  tasks:
# [STEP 1] Windows 호스트 선행 소프트웨어 설치
    - name: Microsoft Visual C++ Redistributable 설치
      win_package:
        path: "{{ vcredist_url }}"
        arguments: /install /quiet /norestart
        state: present
      register: vcredist_result
      # 이미 설치되어 있어 발생하는 1638 에러를 무시하거나 성공으로 간주
      failed_when: vcredist_result.rc not in [0, 1638, 3010] 

    - name: VirtualBox 소프트웨어 설치
      win_package:
        path: "{{ vbox_installer_url }}"
        arguments: /s
        state: present

# [STEP 2] VM 생성 및 가상 하드웨어/디스크 구성
    - name: VirtualBox VM 및 가상 디스크(40GB) 생성
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $disk_dir = "C:\VM_Storage"
        
        # 1. 저장소 폴더 생성
        if (!(Test-Path $disk_dir)) { New-Item -ItemType Directory -Path $disk_dir }

        # 2. VM 존재 여부 확인 후 생성
        if (!(& $vbox list vms | Select-String "{{ vm_name }}")) {
          # VM 등록
          & $vbox createvm --name "{{ vm_name }}" --register
          
          # 가상 하드디스크 생성 (40GB 설정)
          & $vbox createmedium disk --filename "{{ vm_disk_path }}" --size {{ vm_disk_size }} --format VDI
          
          # 하드웨어 설정 (메모리, CPU, 브릿지 네트워크)
          & $vbox modifyvm "{{ vm_name }}" --memory {{ vm_memory }} --cpus {{ vm_cpus }} --nic1 bridged
          
          # 저장소 컨트롤러 추가
          & $vbox storagectl "{{ vm_name }}" --name "SATA" --add sata
          
          # 하드디스크 연결 (Port 0)
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 0 --device 0 --type hdd --medium "{{ vm_disk_path }}"
          
          # 게스트 확장 ISO 연결 (Port 1)
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 1 --device 0 --type dvddrive --medium "{{ guest_iso }}"
        }

    # [STEP 3] VM 내부 계정 및 권한 설정 (master/1234, sudo 무설정)
    - name: VM 내부 보안 및 권한 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }}:{{ vm_pass }}' | chpasswd"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"

    # [STEP 4] SSH 마스터키 주입
    - name: SSH 공개키 등록 (비번 없이 로그인)
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pubKey = Get-Content "~/.ssh/id_rsa.pub"
        & $vbox guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /bin/bash -c "mkdir -p ~/.ssh && echo '$pubKey' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

    # [STEP 5] 고정 IP 설정
    - name: VM 네트워크 고정 IP 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $conf = "auto eth0`niface eth0 inet static`naddress {{ vm_static_ip }}`nnetmask 255.255.255.0`ngateway {{ vm_gw }}`ndns-nameservers {{ vm_dns }}"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /bin/bash -c "echo '$conf' > /etc/network/interfaces && systemctl restart networking"


#또는
# [STEP 5] 고정 IP 설정 (Ubuntu Netplan 기준)
#    - name: VM 네트워크 고정 IP 설정 (인벤토리 변수 기반)
#      win_shell: |
#        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
#        $conf = @"
#        network:
#          version: 2
#          renderer: networkd
#          ethernets:
#            enp0s3:
#              dhcp4: no
#              addresses: [{{ vm_static_ip }}/24]
#              gateway4: {{ vm_gw }}
#              nameservers:
#                addresses: [{{ vm_dns }}]
#        "@
#        # 설정 파일 생성 및 적용
#        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /bin/bash -c "echo '$conf' > /etc/netplan/01-netcfg.yaml && netplan apply"


    # [STEP 6] 외부 패키지 목록(packages.yml) 설치
    - name: VM 초기 패키지 일괄 설치
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pkgs = "{{ common_packages | join(' ') }}"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get update
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get install -y $pkgs

```

---

## 3. 실행 가이드

1. **대상 Windows PC**: `scripts/setup_winrm.ps1`을 관리자 권한으로 실행합니다.
2. **앤서블 서버**: `inventory/hosts.ini`에 대상 PC 정보를 입력합니다.
3. **배포 시작**: 아래 명령어를 입력합니다.
```bash
ansible-playbook -i inventory/hosts.ini site.yml

```



### ⚠️ 비용 및 환경 체크

* **AWS 사용 시**: Bare Metal 인스턴스는 비용이 높으므로 실습 종료 후 반드시 **인스턴스 종료(Terminate)**를 확인하세요.
* **파일 무시**: `.gitignore`에 `.ssh`가 포함되어 있으므로 키 파일 자체는 푸시되지 않으니 안심하셔도 됩니다.

Next Step: VM 생성 후 내부 서비스 정상 동작 여부 자동 점검 방법
