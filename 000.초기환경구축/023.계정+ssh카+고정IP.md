## VirtualBox 및 DevOps 도구 통합 배포 최종 프로젝트 (개정판)

이 프로젝트는 Windows 호스트 환경에서 VirtualBox 인프라를 구축하고, 생성된 VM 내부의 보안 및 네트워크 설정을 자동화하는 전체 공정을 포함합니다. 요청하신 사용자 계정 설정, SSH 키 주입, 네트워크 고정 IP 설정 및 가변적인 설치 프로그램 관리 기능을 추가하였습니다.

---
## 대상 PC 선행작업  
WinRM 설정은 **'닭과 달걀'**의 문제입니다. 앤서블이 대상 PC에 접속하려면 WinRM이 열려 있어야 하는데, WinRM을 여는 작업을 앤서블로 할 수는 없기 때문입니다. 따라서 **최초 1회**는 대상 Windows PC에서 수동으로(또는 USB, Active Directory GPO 등을 통해) 설정을 해주어야 합니다.

대상 PC에서 setup_winrm.ps1 파일을 다운로드 받아 관리자권한으로 한번 실행시켜주세요.

---

## 1. 프로젝트 디렉토리 구조

```text
ansible-devops-project/
├── inventory/
│   └── hosts.ini            # 호스트 및 VM 네트워크 정보
├── vars/
│   ├── main.yml             # 시스템 경로 및 인프라 설정
│   └── packages.yml         # [신규] 초기 설치 프로그램 목록
├── scripts/
│   └── setup_winrm.ps1      # [최초 1회용] WinRM 활성화 스크립트
└── site.yml                 # 전체 공정 통합 플레이북

```

---

## 2. 파일별 상세 내용

### ① [최초 실행용] WinRM 활성화 스크립트 (`scripts/setup_winrm.ps1`)

앤서블 접속이 막혔을 때, 대상 Windows PC에서 **관리자 권한**으로 딱 한 번만 실행하면 모든 방화벽과 포트를 열어줍니다.

```powershell
# 이 스크립트는 대상 Windows PC에서 직접 실행합니다.
$url = "https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1"
$file = "$env:temp\ConfigureRemotingForAnsible.ps1"
(New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)
powershell.exe -ExecutionPolicy ByPass -File $file

# WinRM 서비스 확인 및 방화벽 수동 개방 (HTTPS 5986)
netsh advfirewall firewall add rule name="WinRM-HTTPS" dir=in action=allow protocol=TCP localport=5986

```
**대상 pc 관리자권한으로 cmd, 파워쉘 실행**
```CMD
$> cd C:\scripts
$> .\setup_winrm.ps1
```

### ② 인벤토리 설정 (`inventory/hosts.ini`)

```ini
[physical_pcs]
# 호스트IP | VM고정IP | 게이트웨이 | DNS
pc-01 ansible_host=192.168.0.3 vm_static_ip=192.168.0.101 vm_gw=192.168.0.1 vm_dns=8.8.8.8
pc-02 ansible_host=192.168.0.4 vm_static_ip=192.168.0.102 vm_gw=192.168.0.1 vm_dns=8.8.8.8

[physical_pcs:vars]
ansible_user=Administrator
ansible_password=YourPassword
ansible_port=5986
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore

```

### ③ 설치 프로그램 리스트 (`vars/packages.yml`)

간단하게 리스트만 관리하여 차후 수정이 용이하게 만들었습니다.

```yaml
# VM 내부(Linux)에 설치할 패키지 목록
common_packages:
  - git
  - curl
  - wget
  - vim
  - net-tools
  - openssh-server

```

### ④ 메인 변수 정의 (`vars/main.yml`)

```yaml
vcredist_url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
vbox_installer_url: "https://download.virtualbox.org/virtualbox/7.0.12/VirtualBox-7.0.12-159484-Win.exe"
ext_pack_url: "https://download.virtualbox.org/virtualbox/7.0.12/Oracle_VM_VirtualBox_Extension_Pack-7.0.12.vbox-extpack"
ext_pack_hash: "33d7284dc4a0ece278f985c002b881fd92b35887955e59824e5c0162dbf03d60"

vm_name: "DevOps-Master-VM"
vm_user: "master"
vm_pass: "1234"  # 강제 입력 비밀번호
guest_iso: "C:\\Program Files\\Oracle\\VirtualBox\\VBoxGuestAdditions.iso"

```

### ⑤ 통합 플레이북 (`site.yml`)

```yaml
---
- name: 호스트 환경 구축 및 VM 내부 설정 통합 프로젝트
  hosts: physical_pcs
  vars_files:
    - vars/main.yml
    - vars/packages.yml

  tasks:
    # [STEP 1] VirtualBox 및 런타임 설치
    - name: Host용 필수 SW 설치
      win_package:
        path: "{{ item.url }}"
        arguments: "{{ item.args }}"
        state: present
      loop:
        - { url: "{{ vcredist_url }}", args: "/install /quiet /norestart" }
        - { url: "{{ vbox_installer_url }}", args: "/s" }

    # [STEP 2] VM 생성 및 가상 하드웨어 구성
    - name: VirtualBox VM 생성
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        if (!(& $vbox list vms | Select-String "{{ vm_name }}")) {
          & $vbox createvm --name "{{ vm_name }}" --register
          & $vbox modifyvm "{{ vm_name }}" --memory 4096 --cpus 2 --nic1 bridged
          & $vbox storagectl "{{ vm_name }}" --name "SATA" --add sata
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 0 --device 0 --type dvddrive --medium "{{ guest_iso }}"
        }

    # [STEP 3] VM 내부 계정 및 권한 설정 (master/1234, sudo 무설정)
    - name: VM 내부 보안 및 권한 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }}:{{ vm_pass }}' | chpasswd"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"

    # [STEP 4] SSH 마스터키 주입
    - name: SSH 공개키 등록 (비번 없이 로그인)
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pubKey = Get-Content "~/.ssh/id_rsa.pub"
        & $vbox guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /bin/bash -c "mkdir -p ~/.ssh && echo '$pubKey' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

    # [STEP 5] 고정 IP 설정
    - name: VM 네트워크 고정 IP 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $conf = "auto eth0`niface eth0 inet static`naddress {{ vm_static_ip }}`nnetmask 255.255.255.0`ngateway {{ vm_gw }}`ndns-nameservers {{ vm_dns }}"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /bin/bash -c "echo '$conf' > /etc/network/interfaces && systemctl restart networking"

    # [STEP 6] 외부 패키지 목록(packages.yml) 설치
    - name: VM 초기 패키지 일괄 설치
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pkgs = "{{ common_packages | join(' ') }}"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get update
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get install -y $pkgs

```

---

## 3. 실행 가이드

1. **대상 Windows PC**: `scripts/setup_winrm.ps1`을 관리자 권한으로 실행합니다.
2. **앤서블 서버**: `inventory/hosts.ini`에 대상 PC 정보를 입력합니다.
3. **배포 시작**: 아래 명령어를 입력합니다.
```bash
ansible-playbook -i inventory/hosts.ini site.yml

```



### ⚠️ 비용 및 환경 체크

* **AWS 사용 시**: Bare Metal 인스턴스는 비용이 높으므로 실습 종료 후 반드시 **인스턴스 종료(Terminate)**를 확인하세요.
* **파일 무시**: `.gitignore`에 `.ssh`가 포함되어 있으므로 키 파일 자체는 푸시되지 않으니 안심하셔도 됩니다.

Next Step: VM 생성 후 내부 서비스 정상 동작 여부 자동 점검 방법
