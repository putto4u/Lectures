## 프로젝트 개요: 인프라 자동화 및 DevOps 통합 구축

본 프로젝트는 **IaC(Infrastructure as Code)** 기술을 활용하여 윈도우 호스트 PC 환경에 **VirtualBox 기반의 가상화 인프라**를 자동으로 배포하고, 생성된 VM 내부의 **보안 설정, 네트워크 구성 및 필수 DevOps 도구**를 표준화된 공정으로 구축하는 것을 목표로 합니다.

대규모 강의 환경이나 실무 배포 환경에서 발생할 수 있는 네트워크 병목 현상을 해결하기 위해, 각 노드 PC의 로컬 저장소(`C:\VM_Storage`)를 활용하는 최적화된 아키텍처를 채택하였습니다.

---

## 1. 프로젝트 디렉토리 구조

효율적인 유지보수와 가독성을 위해 역할을 분리한 디렉토리 구조입니다.

```plaintext
ansible-devops-project/
├── inventory/
│   └── hosts.ini            # 대상 노드 PC 및 VM 네트워크 매핑 정보
├── vars/
│   ├── main.yml             # 설치 경로, 버전 정보 등 시스템 변수
│   └── packages.yml         # VM 내부에 설치할 초기 패키지 목록
├── scripts/
│   └── setup_winrm.ps1      # [최초 1회] Windows 원격 관리를 위한 설정 스크립트
└── site.yml                 # 전체 공정을 통합 제어하는 메인 플레이북

```

---

## 2. 구성 파일 상세 정의

### ① 인벤토리 설정 (`inventory/hosts.ini`)

대상 노드 PC의 접속 정보와 해당 PC에 생성될 VM에 부여할 고정 IP 정보를 매핑합니다.

```ini
[physical_pcs]
# 호스트 IP | VM 고정 IP | 게이트웨이 | DNS
pc-01 ansible_host=192.168.0.3 vm_static_ip=192.168.0.101 vm_gw=192.168.0.1 vm_dns=8.8.8.8
pc-02 ansible_host=192.168.0.4 vm_static_ip=192.168.0.102 vm_gw=192.168.0.1 vm_dns=8.8.8.8

[physical_pcs:vars]
ansible_user=Administrator
ansible_password=YourPassword
ansible_port=5986
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore

```

### ② 시스템 환경 변수 (`vars/main.yml`)

로컬 저장소를 참조하도록 경로를 확정하고 VM의 하드웨어 사양을 정의합니다.

```yaml
# 로컬 스토리지 및 파일 경로 (C:\VM_Storage에 미리 준비)
local_storage_path: "C:\\VM_Storage"
vcredist_local_path: "{{ local_storage_path }}\\vc_redist.x64.exe"
vbox_local_path: "{{ local_storage_path }}\\vbox_installer.exe"
ubuntu_iso_path: "{{ local_storage_path }}\\ubuntu-22.04.3-live-server-amd64.iso"

# 가상머신(VM) 사양 및 계정 설정
vm_name: "DevOps-Node-PC"
vm_user: "master"
vm_pass: "1234"
vm_memory: 2048
vm_cpus: 2
vm_disk_size: 20480  # 20GB
vm_disk_full_path: "{{ local_storage_path }}\\{{ vm_name }}.vdi"
guest_iso: "C:\\Program Files\\Oracle\\VirtualBox\\VBoxGuestAdditions.iso"

```

### ③ 통합 배포 플레이북 (`site.yml`)

선행 런타임 설치부터 VM 네트워크 설정까지의 전체 공정입니다.

```yaml
---
- name: 로컬 저장소 기반 가상화 환경 및 DevOps 인프라 구축
  hosts: physical_pcs
  vars_files:
    - vars/main.yml
    - vars/packages.yml

  tasks:
    # [STEP 1] Windows 호스트 선행 소프트웨어 설치
    - name: VC++ 2015-2022 런타임 설치 (로컬)
      win_package:
        path: "{{ vcredist_local_path }}"
        arguments: /install /quiet /norestart
        state: present
      register: vcredist_result
      failed_when: vcredist_result.rc not in [0, 1638, 3010]

    - name: VirtualBox 7.0.12 LTS 설치 (로컬)
      win_package:
        path: "{{ vbox_local_path }}"
        arguments: /s
        state: present

    # [STEP 2] VM 생성 및 하드웨어 구성
    - name: VirtualBox VM 및 가상 디스크 생성
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        if (!(& $vbox list vms | Select-String "{{ vm_name }}")) {
          & $vbox createvm --name "{{ vm_name }}" --register
          & $vbox createmedium disk --filename "{{ vm_disk_full_path }}" --size {{ vm_disk_size }} --format VDI
          & $vbox modifyvm "{{ vm_name }}" --memory {{ vm_memory }} --cpus {{ vm_cpus }} --nic1 bridged
          & $vbox storagectl "{{ vm_name }}" --name "SATA" --add sata
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 0 --device 0 --type hdd --medium "{{ vm_disk_full_path }}"
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 1 --device 0 --type dvddrive --medium "{{ ubuntu_iso_path }}"
        }

    # [STEP 3] VM 내부 마스터 계정 및 권한 설정
    - name: 마스터 계정(master/1234) 생성 및 sudo 무패스워드 설정
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }}:{{ vm_pass }}' | chpasswd"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password tmp_pass -- /bin/bash -c "echo '{{ vm_user }} ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers"

    # [STEP 4] SSH 공개키 주입 (마스터 서버 접근 권한)
    - name: 마스터 서버의 SSH 공개키 등록
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pubKey = Get-Content "~/.ssh/id_rsa.pub"
        & $vbox guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /bin/bash -c "mkdir -p ~/.ssh && echo '$pubKey' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

    # [STEP 5] 네트워크 환경 고정 IP 설정 (Ubuntu Netplan)
    - name: VM 네트워크 고정 IP 설정 적용
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $conf = @"
        network:
          version: 2
          renderer: networkd
          ethernets:
            enp0s3:
              dhcp4: no
              addresses: [{{ vm_static_ip }}/24]
              gateway4: {{ vm_gw }}
              nameservers:
                addresses: [{{ vm_dns }}]
        "@
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /bin/bash -c "echo '$conf' > /etc/netplan/01-netcfg.yaml && netplan apply"

    # [STEP 6] 필수 DevOps 패키지 설치
    - name: VM 초기 패키지(Git, Vim 등) 일괄 설치
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $pkgs = "{{ common_packages | join(' ') }}"
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get update
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get install -y $pkgs

```

---

## 3. 실행 가이드 및 주의사항

1. **사전 파일 준비**: 모든 노드 PC의 `C:\VM_Storage` 경로에 VC++ 런타임, VirtualBox 설치파일, Ubuntu ISO가 존재하는지 반드시 확인하십시오.
2. **WinRM 활성화**: `scripts/setup_winrm.ps1`을 관리자 권한으로 1회 실행하여 앤서블 통로를 확보하십시오.
3. **명령어 실행**:
```bash
ansible-playbook -i inventory/hosts.ini site.yml

```



### ⚠️ 비용 및 환경 체크

* **AWS 기반 호스트**: 중첩 가상화 지원(metal 인스턴스) 여부를 확인하십시오. 미사용 시 인스턴스를 즉시 **종료(Terminate)**하여 과금을 방지하십시오.
* **로컬 파일명**: `vars/main.yml`의 파일명과 실제 파일명이 일치하지 않을 경우 설치가 중단됩니다.

---

교재용으로 프로젝트 소개부터 디렉토리 구조, 그리고 로컬 스토리지를 활용한 효율적인 배포 로직을 모두 정리하였습니다.

Next Step: VM 내부 서비스 자동 진단 스크립트 구성
